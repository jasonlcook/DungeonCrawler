@page "/"

@inject IDungeonDataManager DungeonManager
@inject HttpClient Http

<HeadContent>
    <link href="css/cssreset-min.css" rel="stylesheet" />
    <link href="css/site.css" rel="stylesheet" />

    <script src="scripts/jquery-3.7.1.min.js"></script>
    <script src="scripts/dungeon_crawler.min.js"></script>
</HeadContent>

<div id="play-area">
    <div class="dungeon">
        <div id="stage">
            @if (dungeon == null) {
                <div class="loading">
                    <img src="/images/tiles/blue/base_tile.png" />
                </div>
            } else {
                <h1>DUNGEON @dungeon.Id.ToString()</h1>
            }
        </div>
    </div>
    <div class="button">
        <button id="advance" @((MarkupString)(advanceButtonDisabled?"disabled" : null))>Advance</button>
    </div>
    <div class="details">
        <div class="adventurer">
            <div class="level">
                <span class="label">Level</span>
                <span class="value" id="current-level">
                    @((MarkupString)dungeonDepth)
                </span>
            </div>
            <div class="stats">
                <div class="health">
                    <span class="label">Health</span>
                    <span class="value" id="current-health">
                        @((MarkupString)health)
                    </span>
                </div>
                <div class="damage">
                    <span class="label">Damage</span>
                    <span class="value" id="current-damage">
                        @((MarkupString)damage)
                    </span>
                </div>
                <div class="protection">
                    <span class="label">Protection</span>
                    <span class="value" id="current-protection">
                        @((MarkupString)protection)
                    </span>
                </div>
            </div>
            <div class="dice"></div>
        </div>
        <div id="log"></div>
    </div>
</div>

<div id="version">
    <span class="api-version">
        @((MarkupString)apiVersion)
    </span>
    <span class="client-version">Client V0.2.1</span>
</div>

@code {
    Dungeon? dungeon = null;
    string apiVersion = "API V0.0.0";

    string dungeonDepth = "0";

    string health = "0";
    string damage = "0";
    string protection = "0";

    bool advanceButtonDisabled = true;

    protected override async Task OnParametersSetAsync() {
        await SetupDungeon();
    }

    async Task SetupDungeon() {
        dungeon = await DungeonManager.GenerateNewDungeon();
        apiVersion = $"API V{dungeon.ApiVersion}";

        dungeonDepth = dungeon.Level.Depth.ToString();

        health = dungeon.Adventurer.HealthBase.ToString();
        damage = dungeon.Adventurer.DamageBase.ToString();
        protection = dungeon.Adventurer.ProtectionBase.ToString();

        await InvokeAsync(StateHasChanged);
    }
}
